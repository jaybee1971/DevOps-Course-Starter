if: "(type = push AND branch IN (master, module_8)) OR (type = pull_request)"
os: linux
dist: bionic
sudo: required

services:
  - docker

env:
  global:
    - FLASK_APP=todo_app.app
    - FLASK_ENV=production
    - secure: TAtZ3ZDXZLhG7PeJBqutF6xXztmu1ZbZXc7ub3G7goSd5xQXcjWkPAyeOMBwIUEj4sRIUn/oWT/XVQejBjkHPO/KCrybd/yopHpVqZDFfGwD064v7EVZJisi4kcmfDzUGsAeZdNa2p1O1WUuhNVONzuqTEinarTS5GH5tS9S3quwdBKgTiyhzbV9eGIz9he6cEw5QbKlgL8hyJzRbTss9wxniTJ71TmT3iXXKg1HPZiQNIbqyn6iFZL7KSpS3ZlhkRed8XTInfuoufl747q3Nt2rKFqRG3JChBrd0FBOX0o0coTFhLTYsQnWGtrNh7zgWfu/Ad6onROeamlFXfIpiMKxybs/InUAUIH9/a/rjj5vkeO2MiCiH6d7Bm5QOKwtKWQbTSDq0D0JEqpmyNbawv9qe9cxRJcTeISSNAXiMCAyPn5MePj6Wyt/3V6tYPLw5/5lmrWhmkwgzdaSRRFvzatOekUNAyDZWbgzl+1eMIewTvskgQ947P7gQQEuRNR3bxrKlgwJKZHCDTZEj70W5J5VLA1l5bU1msddF/89/2hErcosiSNOnF9LhlmyhhEHOgOnn178Wb3wfrW0+cLK3RbqzHajbKCPTO+bfTdmj47T4ATwtbRkYlY0jk7fk0whA1BwHMnprYe259VcqvPnc2s8tiX0Zg/SuxkeW2fegjA=
    - secure: jlQQBpU4Kx3KB3rzD8AUb1+2EggiLwWWchAeoxyAUJCgJ0jaQwegQJ8QGKek+g1zsUDTmPBP9zmIAF5CxZm4oqi08oB9U3yk9AtfL5s3eG0lFhOBNeVK3DyKQj2VB67sVmkXR78BGM+4pQoo44mnLlHvO0k1i0P9GArL0+aMGEJ4ut8aD6cCTozhvDmzicN2vgNJ/zQUOS8W1Rbl0sFZGuc8n/fsUC69bHzflLtsPAdHQyg5DW99uYvXq7voPinKICV4zugzHuqWGa7INz6bJAwGyYchL7pbCztppR30xOraj6yRotlovBekc/yKSJxumYZ+vy8aYV34pdC0XdRC0RE/gOJZ7kb1wDJKv4hECTQhlDVMws+OJ/WVUkBOBlVXoIqlrYGVV9guvIPOgLouCjX0foVjzXbpgiw+S5pZPs3dzD3dVibbGZ5KEC9JfiR1uQf+0qNko2jijgyqrRJ+jwvQ3NahckjckRVfx1Ww8x4QyCvKzkEPGPN2eaELxvIYwbZTDL41qFOCuGRopJkkT4LV8G7yGyls2eWwxFo7F3tlLqQNn8zPmZewhXwkoHeOyRoqSUT6FCOY1AzLcN56MJIZGz9YViAtcsOJfEJlBdvyYOPmBOvrBABVTY6atKSKROsKOGQgaui3qsTe658H9xAkpZmc26lsuaGhpnUJMT8=
    - secure: U9GPJl+7EwQHRHaAb9e2/sIlwapBaDjxCAdK+3Of/ZDW0vhjlZ63dSUDBbHmx0SXRDlJUjwZQgqDyyO8biYne8jJWojeZmHYW5kxUeiq2Y87+GptGtSZ5r4YDDiTkr5bUjJhhby0GxKcEqo1ZraXOJTROmxkXTXC1UkW/9pUz6s1mEtmGJEEOU3gy4TGia0Mv0xZsoA2ZCNCVwFL9/9sTyQOGQlS1HD3QIA0ebfXPJlhoQMnMqzilo8cx+l8rY+yyBrztL9TMr1RZkNUtvnBy2Y+8XawnAZoe5rdfUNXb+3lUSnF6+p72qls/Z1Ab1S9e+MiIbpREnpfsYWS1Xepme+AWg0flKrOX4vi4Fi5B9l43nhEWgno9/5H42CJWWnc7zlSBsTKM/Nre8y3lzqFyoIMQUatquoQCVHBn/1JTBfA9lgjwONv8ZW8nnQbFcydvPl5dpgyPDODpU3wo3iKY8KiYTKiqJWX5pYzGsMxCuUEhfNm00pRc+14B7oRUgsOv9x2iuxd+rKV+rbCLF84q21GDYIwLeSudPNFiNVJg9a2IP91gdGXuWZnfRhv1dzXvUAvUBMZPOagL+SY2uXhEXq/SJyGDC1s5TMw8uHhRqD7dexzcPZxfNQuHaUnNWf1l6od/PREveuKcK9EaSObmifZiMbFmLZkVtlFtgOQXLM=
    - COL_1="Not Started"
    - COL_2="In Progress"
    - COL_3="Completed"
    - DOCKER_USERNAME="jaybee1971"
    - secure: M8fRVi+KFg+KJoVhrdYJwrQWwSuiL8EI0H78FUeVHF8HwnZL70j6rf/cb+xZi0lN2NFQtDlMxoSR4W3kQh2EO6VBsuJJ0QT5Ngv6zUh9F+Bk89BVqC1Qg9cutQCiKjL2Yk78lqR0q+/PdxV7VjPRXa9MT42ViYlBcXLFpKn3i+y9Z4soWJ0qrtcqMJmz8E9Xq5crG5ndGOWTTJa6yeEw1XLcMJ5m1UPRajor0Mxvy8M+S725QLYHBj3fQp5eId25UTcWt4A4uQf+xPkMg/1dEdtGG5P5mLaaOhMRpIvWeh27IFjTyPH5XIO444o+zKtjI3X5qF8Ypt7v+lRuLYusWwqaXH2pPo3hUFq9E0uuZkIEI1vJKSvGijT1/kAx0F710U9yb4vnxNgzO0hDtn/4lmbytcuSa06rL8yQI1eKM4EfKqpQTgcR8BD2Kuh08HYf+v79bMk2m9+uNduRkJDPd6Nu82OEWyYB+IyYbyt2KwqboHWteetrmhD7FjRkl1Jms3nX8eQ8FGir+ZHoc4uy8gqt3OGxxcHIM7dzcBkdBykBjVgmpw8lnp1KleIaqleB1G3v+Mg7SHHSDssss5ict5s/RIMllPhnqGUMHarwymx2KGyutmGsaDuWcMmKYJXUQYLANmvor019ozE+Rb+fEqW8jcpJd1TfdGkZytYfXxs=
    - DOCKER_COMPOSE_VERSION=1.27.4
    - CACHE_IMAGE=jaybee1971/todo_app
    - DOCKER_BUILDKIT=1
    - COMPOSE_DOCKER_CLI_BUILD=1

before_install:
  - set -e
  # install docker
  - echo '{"experimental":true}' | sudo tee /etc/docker/daemon.json
  - export DOCKER_CLI_EXPERIMENTAL=enabled
  - docker run --rm --privileged docker/binfmt:a7996909642ee92942dcd6cff44b9b95f08dad64
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce=5:19.03.8~3-0~ubuntu-bionic
  - docker info
  # install docker compose
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

before_script:
  - echo "$DOCKER_PASSWORD" | docker login -u $DOCKER_USERNAME --password-stdin

script:
  - docker-compose --file docker-compose-travis.yml up --build --build-arg BUILDKIT_INLINE_CACHE=1 --exit-code-from todoapp

deploy:
  - provider: script
    script: bash docker_push
    on:
      branch: module_8
  # - provider: heroku
  #   api_key:
  #     secure: gJnbRKysbjCFWuueZZcjiWgSsGP7Vxpu3xi6oEyMU6AEUyJGUBOco0456u75N7Yfxp9opyZfRKwaQ5dgIneetlgTZBYSVJPQoyczmTu+GvtzgapWlmJqT1XabvgPjpqHpHWnQPkkSs+AKPCM4+dRdAEFlR8HfHb8TmMFnQbWUp/uOVyyKikUfwCnpe6UN6woek0uA9SwrZTeO6iiPKn5bwNeagcS9N1MVzOCj3WJq6GlrKOW1tIFfUx5QPpn2ZEliGxCUSR/05njW45JHq8b+eoOHluSN1pFv7NEqMJNHP8qW9PlJ3Ek9Acc9xuaV/eeu1NvxbMvXjOwrPjE87o/1Iti4zGOkO8tCegW++05Hawj/SLnFvGrTJ9dqjNv9mU6hTdb5Fr0rfjTcnY7oCiZTvTxBuzkffZe1ddSxAZal3R0gDhKPj+l8oI0GF+n5WOu5PNJbtdBCyX8KFAY68k2xX5d4dUCuv3L0IlOVXmGV+QO5Bu8bhAI/UJD0I/G0Ggw42Br32/AA2kSu97zurIRvjncciaLTVSvWWRZE4Gb4OZ+DKNslTpq5A34M8R+vV2+r3IDjQVE1Aqj9b+EKpTE09pbKZFyrCIjO4z80jGmLqHcl1jFQC1HpfMo6STinNf1dHOWVcX8Wi2ZVhHaAZsC2+mGLHnpm3XraJtjudz3ggk=
  #   app: jaybee1971-todoapp

notifications:
  email:
    recipients:
      - jay.bee71@outlook.com
    on_success: never
    on_failure: always
